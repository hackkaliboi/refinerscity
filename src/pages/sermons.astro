---
import Layout from '../layouts/Layout.astro';
import { format } from 'date-fns';
import { LiveStreamBadge } from '../components/LiveStreamBadge';
import { StreamCountdown } from '../components/StreamCountdown';
import { getSermons } from '../lib/api';

// Fetch sermons from database
const { data: sermons, error } = await getSermons();

// Separate live and scheduled sermons
const liveSermons = sermons?.filter(s => s.is_live) || [];
const scheduledSermons = sermons?.filter(s => s.stream_status === 'scheduled' && s.scheduled_stream_time) || [];
const regularSermons = sermons?.filter(s => !s.is_live && s.stream_status !== 'scheduled') || [];

// Analytics tracking function
const trackPlatformClick = (platform: string) => {
  // Implementation would go here
  console.log(`Clicked ${platform} link`);
};
---

<Layout title="Sermons">
  <main>
    <!-- Hero Section -->
    <section class="bg-primary-800 text-white py-16">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="text-4xl font-bold mb-4">Sermons</h1>
        <p class="text-xl text-primary-200">Watch and listen to our latest messages</p>
      </div>
    </section>

    <!-- Streaming Platforms Section -->
    <section class="py-8 bg-primary-50">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-md p-6 border border-primary-100">
          <h2 class="text-2xl font-bold text-primary-800 mb-6 text-center">Listen on Your Favorite Platform</h2>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <a 
              href="https://open.spotify.com/show/example" 
              target="_blank" 
              rel="noopener noreferrer"
              class="flex flex-col items-center p-4 rounded-lg hover:bg-primary-50 transition-all duration-300"
              onclick="trackPlatformClick('spotify')"
            >
              <svg class="w-12 h-12 text-[#1DB954]" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
              </svg>
              <span class="mt-2 font-semibold text-primary-800">Spotify</span>
              <span class="text-sm text-primary-600">2.5K Subscribers</span>
            </a>
            
            <a 
              href="https://podcasts.apple.com/show/example" 
              target="_blank" 
              rel="noopener noreferrer"
              class="flex flex-col items-center p-4 rounded-lg hover:bg-primary-50 transition-all duration-300"
              onclick="trackPlatformClick('apple-podcasts')"
            >
              <svg class="w-12 h-12 text-[#872EC4]" viewBox="0 0 24 24" fill="currentColor">
                <path d="M5.34 0A5.328 5.328 0 000 5.34v13.32A5.328 5.328 0 005.34 24h13.32A5.328 5.328 0 0024 18.66V5.34A5.328 5.328 0 0018.66 0zm6.525 2.568c2.336 0 4.448.902 6.056 2.587 1.224 1.272 1.912 2.619 2.264 4.392.12.59.12 2.2.007 2.864a8.506 8.506 0 01-3.24 5.296c-.608.46-2.096 1.261-2.336 1.261-.088 0-.096-.091-.056-.46.072-.592.144-.715.48-.856.536-.224 1.448-.874 2.008-1.435a7.644 7.644 0 002.008-3.536c.208-.824.184-2.656-.048-3.504-.728-2.696-2.928-4.792-5.624-5.352-.784-.16-2.208-.16-3 0-2.728.56-4.984 2.76-5.672 5.528-.184.736-.184 2.48 0 3.216.456 1.832 1.64 3.512 3.192 4.512.304.2.672.408.824.472.336.144.408.264.48.856.04.369.032.46-.056.46-.056 0-.464-.176-.896-.384l-.04-.03c-2.472-1.216-4.056-3.274-4.632-6.012-.144-.706-.168-2.392-.04-3.072.336-1.824 1.096-3.304 2.324-4.552 1.608-1.685 3.72-2.587 6.056-2.587zm.166 3.36c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm-2.932 1.074c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm5.864 0c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm-2.932 1.074c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm-2.932 1.074c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm5.864 0c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm-2.932 1.074c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm-2.932 1.074c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm5.864 0c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298zm-2.932 1.074c.164 0 .296.134.296.298v.888c0 .164-.132.298-.296.298h-.036a.297.297 0 01-.296-.298v-.888c0-.164.132-.298.296-.298z"/>
              </svg>
              <span class="mt-2 font-semibold text-primary-800">Apple Podcasts</span>
              <span class="text-sm text-primary-600">1.8K Subscribers</span>
            </a>
            
            <a 
              href="https://podcasts.google.com/feed/example" 
              target="_blank" 
              rel="noopener noreferrer"
              class="flex flex-col items-center p-4 rounded-lg hover:bg-primary-50 transition-all duration-300"
              onclick="trackPlatformClick('google-podcasts')"
            >
              <svg class="w-12 h-12 text-[#4285F4]" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm0 21.333c-5.148 0-9.333-4.185-9.333-9.333S6.852 2.667 12 2.667 21.333 6.852 21.333 12 17.148 21.333 12 21.333zm0-16c-3.682 0-6.667 2.985-6.667 6.667S8.318 18.667 12 18.667 18.667 15.682 18.667 12 15.682 5.333 12 5.333zm0 10.667c-2.205 0-4-1.795-4-4s1.795-4 4-4 4 1.795 4 4-1.795 4-4 4z"/>
              </svg>
              <span class="mt-2 font-semibold text-primary-800">Google Podcasts</span>
              <span class="text-sm text-primary-600">1.2K Subscribers</span>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Live Streams Section -->
    {liveSermons.length > 0 && (
      <section class="py-8 bg-gradient-to-br from-red-50 to-pink-50">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <h2 class="text-3xl font-bold text-red-800 mb-6 text-center flex items-center justify-center">
            <span class="flex h-3 w-3 mr-3">
              <span class="animate-ping absolute inline-flex h-3 w-3 rounded-full bg-red-600 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-red-600"></span>
            </span>
            Live Now
          </h2>
          <div class="grid grid-cols-1 gap-6">
            {liveSermons.map((sermon) => (
              <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-red-500">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex-1">
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">{sermon.title}</h3>
                    <p class="text-gray-600">{sermon.speaker}</p>
                    {sermon.description && (
                      <p class="text-gray-700 mt-2">{sermon.description}</p>
                    )}
                  </div>
                  <LiveStreamBadge 
                    client:load
                    isLive={true}
                    streamUrl={sermon.live_stream_url || sermon.video_url}
                    platform={sermon.stream_platform}
                  />
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Scheduled Streams Section -->
    {scheduledSermons.length > 0 && (
      <section class="py-8 bg-primary-50">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <h2 class="text-3xl font-bold text-primary-800 mb-6 text-center">Upcoming Live Streams</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {scheduledSermons.map((sermon) => (
              <div>
                <h3 class="text-xl font-bold text-gray-900 mb-4">{sermon.title}</h3>
                <StreamCountdown 
                  client:load
                  scheduledTime={sermon.scheduled_stream_time}
                  streamUrl={sermon.live_stream_url || sermon.video_url}
                />
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Search and Filter -->
    <section class="py-8 bg-primary-50">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col md:flex-row gap-4">
          <input
            type="text"
            placeholder="Search sermons..."
            class="flex-1 px-4 py-2 rounded-md border border-primary-200 focus:outline-none focus:ring-2 focus:ring-primary-500"
          />
          <select class="px-4 py-2 rounded-md border border-primary-200 focus:outline-none focus:ring-2 focus:ring-primary-500">
            <option value="">All Series</option>
            <option value="faith-foundations">Faith Foundations</option>
            <option value="prayer-life">Prayer Life</option>
            <option value="purpose-driven">Purpose Driven</option>
          </select>
          <select class="px-4 py-2 rounded-md border border-primary-200 focus:outline-none focus:ring-2 focus:ring-primary-500">
            <option value="">All Speakers</option>
            <option value="john-smith">Pastor John Smith</option>
            <option value="sarah-johnson">Pastor Sarah Johnson</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Sermons Grid -->
  <section class="py-16">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <h2 class="text-3xl font-bold text-primary-800 mb-8 text-center">Recent Sermons</h2>
      
      {error ? (
        <div class="text-center py-12 text-red-600">
          <p>Error loading sermons. Please try again later.</p>
        </div>
      ) : regularSermons.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {regularSermons.map((sermon) => (
            <div class="bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 hover:shadow-lg border border-primary-100">
              <div class="aspect-w-16 aspect-h-9 bg-primary-100">
                {sermon.thumbnail_url ? (
                  <img src={sermon.thumbnail_url} alt={sermon.title} class="object-cover w-full h-full" />
                ) : (
                  <div class="flex items-center justify-center">
                    <span class="text-primary-600">Sermon Video</span>
                  </div>
                )}
              </div>
              <div class="p-6">
                <h3 class="text-xl font-semibold text-primary-800 mb-2">{sermon.title}</h3>
                <p class="text-primary-600 mb-2">{sermon.speaker}</p>
                <p class="text-primary-500 text-sm mb-4">
                  {format(new Date(sermon.date), 'MMMM d, yyyy')}
                  {sermon.series && ` | ${sermon.series}`}
                </p>
                {sermon.description && (
                  <p class="text-primary-700 mb-4 line-clamp-3">{sermon.description}</p>
                )}
                
                <!-- Listen Now Button with Dropdown -->
                <div class="relative group">
                  {sermon.video_url ? (
                    <a
                      href={sermon.video_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="w-full block text-center bg-primary-600 text-white px-4 py-2 rounded-md font-medium hover:bg-primary-700 mb-2 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 shadow-sm hover:shadow-md"
                    >
                      Watch Video
                    </a>
                  ) : (
                    <button
                      class="w-full bg-primary-600 text-white px-4 py-2 rounded-md font-medium hover:bg-primary-700 mb-2 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 shadow-sm hover:shadow-md"
                    >
                      Listen Now
                    </button>
                  )}
                  
                  {/* Podcast Links */}
                  {(sermon.spotify_url || sermon.apple_podcasts_url || sermon.google_podcasts_url) && (
                    <div class="hidden group-hover:block absolute bottom-full left-0 w-full bg-white rounded-lg shadow-lg p-2 mb-1 border border-primary-200">
                      {sermon.spotify_url && (
                        <a
                          href={sermon.spotify_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="flex items-center p-2 hover:bg-primary-50 rounded text-sm"
                        >
                          <span class="text-[#1DB954] mr-2">ðŸŽµ</span>
                          Spotify
                        </a>
                      )}
                      {sermon.apple_podcasts_url && (
                        <a
                          href={sermon.apple_podcasts_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="flex items-center p-2 hover:bg-primary-50 rounded text-sm"
                        >
                          <span class="text-[#872EC4] mr-2">ðŸŽ§</span>
                          Apple Podcasts
                        </a>
                      )}
                      {sermon.google_podcasts_url && (
                        <a
                          href={sermon.google_podcasts_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="flex items-center p-2 hover:bg-primary-50 rounded text-sm"
                        >
                          <span class="text-[#4285F4] mr-2">ðŸ“»</span>
                          Google Podcasts
                        </a>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-12 text-gray-600">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          <p class="text-lg">No sermons available yet.</p>
          <p class="text-sm mt-2">Check back soon for new content!</p>
        </div>
      )}
    </div>
  </section>
  </main>
</Layout>

<script>
  // Analytics tracking function
  function trackPlatformClick(platform: string) {
    // Implementation would go here - connect to your analytics service
    console.log(`Clicked ${platform} link`);
  }
</script>

<style>
  /* Smooth hover transitions */
  .transition-colors {
    transition: background-color 0.3s ease;
  }
  
  /* Improved mobile responsiveness */
  @media (max-width: 640px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
</style>
